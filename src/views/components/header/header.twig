{#
| Variable         | Type    | Description                     |
|------------------|---------|---------------------------------|
| cart             | object  |                                 |
| cart.items_count | int     |                                 |
| cart.total       | string  | Formatted total ex: "١٠٠ ر.س"   |
#}
{% set important_links = theme.settings.get('important_links') %}
<header class="store-header" style="height: auto; min-height: auto;">
  {# Top Nav - Only 4 Elements #}
  <div class="top-navbar text-white" style="background-color: #000000; height: auto; padding: 8px 0;">
    <div class="container flex justify-between items-center" style="height: auto;">
      
      {# Left side - Cart and Profile #}
      <div class="flex items-center gap-3">
          {# 1. Cart Icon #}
          <a href="{{ store.url }}/cart" 
             class="cart-icon text-white hover:opacity-80 transition-opacity" 
             style="
               cursor: pointer;
               display: flex;
               align-items: center;
               justify-content: center;
               width: 40px;
               height: 40px;
               border-radius: 50%;
               background: transparent;
               border: none;
               transition: all 0.3s ease;
               text-decoration: none;
             ">
            <img src="{{ 'images/icons/bitcoin-icons_cart-outline.png'|asset }}" 
                 alt="Cart" 
                 style="
                   width: 20px;
                   height: 20px;
                 " />
          </a>
          
          {# 2. Profile Icon #}
          {% if user.type=='user' %}
            <salla-user-menu avatar-only show-header class="text-white"></salla-user-menu>
          {% else %}
              <button class="text-white hover:opacity-80 transition-opacity" 
                      aria-label="user-icon" 
                      onclick="salla.event.dispatch('login::open')"
                      style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 40px;
                        height: 40px;
                        background: transparent;
                        border: none;
                        cursor: pointer;
                      ">
                <img src="{{ 'images/icons/iconamoon_profile-thin.svg'|asset }}" 
                     alt="Profile" 
                     style="
                       width: 20px;
                       height: 20px;
                       filter: brightness(0) invert(1);
                     " />
              </button>
          {% endif %}
      </div>
      
      {# 3. Logo #}
      <div class="flex-1 flex justify-center">
          <a class="navbar-brand" href="{{ store.url }}">
              <img fetchpriority="high" width="100%" height="100%" loading="eager" src="{{ 'images/logo.png'|asset }}" alt="{{ store.name }} logo" class="max-h-8">
              {% if is_page('index') %}
                <h1 class="sr-only">{{ store.name }}</h1>
              {% else %}
                <h2 class="sr-only">{{ store.name }}</h2>
              {% endif %}
          </a>
      </div>
      
      {# 4. Language Icon #}
      {% if store.settings.is_multilingual or store.settings.currencies_enabled %}
        <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity" onclick="switchLanguage()">
            <span class="text-white font-comfortaa text-[12px] font-normal leading-[25px]" id="language-toggle-text">
              {{ user.language.code == 'ar' ? 'En' : 'Ar' }}
            </span>
            <img 
              src="{{ 'images/icons/material-symbols-light_language.png'|asset }}" 
              alt="Language" 
              class="w-5 h-5"
              data-translate-alt="header.language"
            />
        </div>
      {% endif %}
      
    </div>
  </div>
</header>
{% if store.scope %}
    <salla-scopes selection="{{ store.scope.display_as == 'popup' ? 'mandatory' : 'optional' }}"></salla-scopes>
{% endif %}

<script>
function switchLanguage() {
  try {
    const doc = document.documentElement;
    const current = (doc.lang || localStorage.getItem('currentLanguage') || '{{ user.language.code }}' || 'ar').toLowerCase();
    const newLang = current === 'ar' ? 'en' : 'ar';

    // Persist + apply immediately
    localStorage.setItem('currentLanguage', newLang);
    doc.lang = newLang;
    doc.dir = newLang === 'ar' ? 'rtl' : 'ltr';

    const toggle = document.getElementById('language-toggle-text');
    if (toggle) toggle.textContent = newLang === 'ar' ? 'En' : 'Ar';

    // Dispatch both variants of language change events
    if (window.salla && window.salla.event && typeof window.salla.event.dispatch === 'function') {
      try { window.salla.event.dispatch('language::changed', newLang); } catch (_) {}
    }
    try {
      const ev = new CustomEvent('languageChanged', { detail: { from: current, to: newLang, language: newLang } });
      document.dispatchEvent(ev);
    } catch (_) {}

    // Call Salla official language change if available
    if (window.salla && window.salla.language && typeof window.salla.language.change === 'function') {
      try { window.salla.language.change(newLang); } catch (_) {}
      try { window.salla.language.current = newLang; } catch (_) {}
    }

    // Refresh custom menu if it exposes refresh()
    const menuEl = document.querySelector('custom-main-menu');
    if (menuEl && typeof menuEl.refresh === 'function') {
      try { menuEl.refresh(); } catch (_) {}
    }

    // Fallback: if nothing updated after a tick, reload with ?lang=
    setTimeout(() => {
      if (window.salla && window.salla.language && window.salla.language.current === newLang) return;
      const url = new URL(window.location.href);
      url.searchParams.set('lang', newLang);
      window.location.href = url.toString();
    }, 200);
  } catch (e) {
    // Hard fallback
    const newLang = (('{{ user.language.code }}' || 'ar').toLowerCase() === 'ar') ? 'en' : 'ar';
    const url = new URL(window.location.href);
    url.searchParams.set('lang', newLang);
    window.location.href = url.toString();
  }
}

// Keep toggle text in sync on init
document.addEventListener('DOMContentLoaded', function() {
  const doc = document.documentElement;
  const current = (new URLSearchParams(window.location.search).get('lang') || localStorage.getItem('currentLanguage') || doc.lang || '{{ user.language.code }}' || 'ar').toLowerCase();
  const toggle = document.getElementById('language-toggle-text');
  if (toggle) toggle.textContent = current === 'ar' ? 'En' : 'Ar';
});

// Optional: when Salla notifies, ensure menu/content refresh
document.addEventListener('languageChanged', function(evt) {
  const toggle = document.getElementById('language-toggle-text');
  if (toggle) toggle.textContent = (evt.detail.to || evt.detail.language) === 'ar' ? 'En' : 'Ar';
  const menuEl = document.querySelector('custom-main-menu');
  if (menuEl && typeof menuEl.refresh === 'function') {
    try { menuEl.refresh(); } catch (_) {}
  }
});
</script>