{#
| Variable         | Type    | Description                     |
|------------------|---------|---------------------------------|
| cart             | object  |                                 |
| cart.items_count | int     |                                 |
| cart.total       | string  | Formatted total ex: "١٠٠ ر.س"   |
#}
{% set important_links = theme.settings.get('important_links') %}
<header class="store-header">
  {# Top Nav #}
  <div class="top-navbar text-white" style="background-color: #000000;">
    <div class="container flex justify-between items-center py-2">
     

      {# Left side - Cart and Profile #}
      <div class="flex items-center gap-3">
          {# Cart icon #}
          <a href="{{ store.url }}/cart" 
             class="cart-icon text-white hover:opacity-80 transition-opacity" 
             style="
               cursor: pointer;
               display: flex;
               align-items: center;
               justify-content: center;
               width: 40px;
               height: 40px;
               border-radius: 50%;
               background: transparent;
               border: none;
               transition: all 0.3s ease;
               text-decoration: none;
             ">
            <img src="{{ 'images/icons/bitcoin-icons_cart-outline.png'|asset }}" 
                 alt="Cart" 
                 style="
                   width: 20px;
                   height: 20px;
                 " />
          </a>
          
          {# Profile icon #}
          {% if user.type=='user' %}
            <salla-user-menu avatar-only show-header class="text-white"></salla-user-menu>
          {% else %}
              <button class="text-white hover:opacity-80 transition-opacity" 
                      aria-label="user-icon" 
                      onclick="salla.event.dispatch('login::open')"
                      style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 40px;
                        height: 40px;
                        background: transparent;
                        border: none;
                        cursor: pointer;
                      ">
                <img src="{{ 'images/icons/iconamoon_profile-thin.svg'|asset }}" 
                     alt="Profile" 
                     style="
                       width: 20px;
                       height: 20px;
                       filter: brightness(0) invert(1);
                     " />
              </button>
          {% endif %}
      </div>
      {# Center - Logo #}
      <div class="flex-1 flex justify-center">
          <a class="navbar-brand" href="{{ store.url }}">
              <img fetchpriority="high" width="100%" height="100%" loading="eager" src="{{ 'images/logo.png'|asset }}" alt="{{ store.name }} logo" class="max-h-8">
              {% if is_page('index') %}
                <h1 class="sr-only">{{ store.name }}</h1>
              {% else %}
                <h2 class="sr-only">{{ store.name }}</h2>
              {% endif %}
          </a>
      </div>
       {# Right side - Language #}
      <div class="flex items-center">
              {% if store.settings.is_multilingual or store.settings.currencies_enabled %}
              <div class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity" onclick="switchLanguage()">
                  <span class="text-white font-comfortaa text-[12px] font-normal leading-[25px]" id="language-toggle-text">
                    {{ user.language.code == 'ar' ? 'En' : 'Ar' }}
                  </span>
                  <img 
                    src="{{ 'images/icons/material-symbols-light_language.png'|asset }}" 
                    alt="Language" 
                    class="w-5 h-5"
                    data-translate-alt="header.language"
                  />
              </div>
          {% endif %}
      </div>
    </div>
  </div>

  {# Main Nav #}
  <div id="mainnav" class="main-nav-container shadow-default bg-black">
      <div class="inner bg-inherit">
          <div class="container">
              <div class="flex items-stretch justify-center relative">
                  <div class="flex items-center">
                      <custom-main-menu></custom-main-menu>
                  </div>
                  
              </div>
          </div>
      </div>
  </div>
</header>
{% if store.scope %}
    <salla-scopes selection="{{ store.scope.display_as == 'popup' ? 'mandatory' : 'optional' }}"></salla-scopes>
{% endif %}

<script>
function switchLanguage() {
    console.log('Header: Language switch initiated');
    
    // Get current language from stored preference or fallback
    let currentLanguage = '{{ user.language.code }}';
    const storedLanguage = localStorage.getItem('currentLanguage');
    const urlLanguage = new URLSearchParams(window.location.search).get('lang');
    
    // Determine current language
    currentLanguage = urlLanguage || storedLanguage || currentLanguage || 'en';
    
    const newLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
    
    console.log('Header: Switching from', currentLanguage, 'to', newLanguage);
    
    // Store the new language preference
    localStorage.setItem('currentLanguage', newLanguage);
    
    // Update HTML attributes
    document.documentElement.lang = newLanguage;
    document.documentElement.dir = newLanguage === 'ar' ? 'rtl' : 'ltr';
    
    // Update language toggle text immediately
    const languageToggleText = document.getElementById('language-toggle-text');
    if (languageToggleText) {
        languageToggleText.textContent = newLanguage === 'ar' ? 'En' : 'Ar';
    }
    
    // Dispatch custom language change event for footer
    const languageChangeEvent = new CustomEvent('languageChanged', {
        detail: {
            from: currentLanguage,
            to: newLanguage,
            language: newLanguage
        }
    });
    document.dispatchEvent(languageChangeEvent);
    console.log('Header: Dispatched languageChanged event:', languageChangeEvent.detail);
    
    // Dispatch Salla custom event
    const sallaLanguageEvent = new CustomEvent('salla:language:changed', {
        detail: {
            language: newLanguage,
            code: newLanguage
        }
    });
    document.dispatchEvent(sallaLanguageEvent);
    console.log('Header: Dispatched salla:language:changed event:', sallaLanguageEvent.detail);
    
    // Use Salla's language change if available
    if (window.salla && window.salla.language) {
        console.log('Header: Calling Salla language change');
        window.salla.language.change(newLanguage);
    } else {
        // Fallback to URL parameter method
        const currentUrl = window.location.href;
        const baseUrl = currentUrl.split('?')[0];
        const newUrl = baseUrl + '?lang=' + newLanguage;
        console.log('Header: Redirecting to:', newUrl);
        window.location.href = newUrl;
    }
}

// Update language toggle text when language changes
document.addEventListener('languageChanged', function(event) {
    const languageToggleText = document.getElementById('language-toggle-text');
    if (languageToggleText) {
        const newLang = event.detail.to || event.detail.language;
        languageToggleText.textContent = newLang === 'ar' ? 'En' : 'Ar';
    }
});

// Initialize language toggle text on page load
document.addEventListener('DOMContentLoaded', function() {
    const storedLanguage = localStorage.getItem('currentLanguage');
    const urlLanguage = new URLSearchParams(window.location.search).get('lang');
    const currentLanguage = urlLanguage || storedLanguage || '{{ user.language.code }}' || 'en';
    
    const languageToggleText = document.getElementById('language-toggle-text');
    if (languageToggleText) {
        languageToggleText.textContent = currentLanguage === 'ar' ? 'En' : 'Ar';
    }
});

</script>
